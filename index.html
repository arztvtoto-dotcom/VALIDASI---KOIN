<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TVTOTO DASHBOARD | MINERA EDITION</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Palette */
            --bg-body: #050507;
            --bg-sidebar: #0b0c15;
            --glass-bg: rgba(20, 20, 30, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            /* Accents */
            --primary: #3b82f6;       /* Clean Blue */
            --primary-glow: rgba(59, 130, 246, 0.2);
            --success: #10b981;       /* Emerald */
            --danger: #ef4444;        /* Red */
            --warning: #f59e0b;       /* Amber */
            --minera: #8b5cf6;        /* Violet for Minera/Coins */
            --minera-glow: rgba(139, 92, 246, 0.2);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            /* Spacing & Sizing */
            --radius-lg: 16px;
            --radius-md: 10px;
            --radius-sm: 6px;
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
            --transition: all 0.2s ease-in-out;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            font-size: 14px; 
        }

        /* Background */
        #bgCanvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 10% 20%, #111827 0%, #050507 90%);
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            flex-shrink: 0;
            z-index: 10;
        }

        .brand {
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .brand-text h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem; font-weight: 700; letter-spacing: 0.5px;
            background: linear-gradient(to right, #fff, #bfdbfe);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }
        .brand-text span { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; }

        .menu-section { margin-bottom: 24px; }
        .menu-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.05em;
            padding-left: 12px;
        }

        .nav-btn {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 10px 12px;
            border-radius: var(--radius-md);
            text-align: left;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex; align-items: center; gap: 12px;
            transition: var(--transition);
            margin-bottom: 4px;
            height: 40px; 
        }

        .nav-btn i { font-size: 1.1rem; opacity: 0.8; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-btn:hover i { opacity: 1; }
        .nav-btn.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .nav-btn.active i { color: var(--primary); }

        /* Operator List */
        .operator-panel { flex: 1; overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
        #opSearch {
            width: 100%; padding: 8px 12px; font-size: 0.85rem; margin-bottom: 12px;
            border-radius: var(--radius-sm); border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.2); color: #fff; transition: var(--transition);
        }
        #opSearch:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); }
        .operator-list { flex: 1; overflow-y: auto; padding-right: 4px; }
        .operator-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; margin-bottom: 4px; background: rgba(255, 255, 255, 0.02);
            border-radius: 6px; font-size: 0.85rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .operator-item span:first-child { overflow: hidden; text-overflow: ellipsis; margin-right: 8px; }
        .op-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; flex-shrink: 0; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; padding: 32px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 24px; 
        }

        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid var(--glass-border); }
        .header-title h2 { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 600; line-height: 1.2; }
        .header-title p { color: var(--text-muted); font-size: 0.85rem; margin-top: 4px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .stat-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg); padding: 20px;
            display: flex; flex-direction: column; justify-content: center;
            position: relative; transition: var(--transition);
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%;
            background: var(--primary); opacity: 0.6; border-radius: 4px 0 0 4px;
        }
        .stat-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.15); }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .stat-value { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; color: #fff; letter-spacing: -0.02em; line-height: 1.1; }

        /* Charts */
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 280px; }

        /* Panels */
        .panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-card); display: flex; flex-direction: column; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--glass-border); }
        .panel-title { font-family: 'Outfit', sans-serif; font-size: 1rem; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 10px; }

        /* Inputs */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px; }
        .input-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
        
        .file-drop-area {
            border: 2px dashed var(--glass-border); border-radius: var(--radius-md);
            padding: 20px; text-align: center; cursor: pointer; transition: var(--transition);
            background: rgba(0,0,0,0.2); color: var(--text-muted); position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px;
        }
        .file-drop-area:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); color: var(--primary); }
        .file-drop-area i { font-size: 24px; margin-bottom: 8px; }
        .file-drop-area span { font-size: 0.85rem; }
        .file-drop-area input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }

        textarea.cyber-input {
            width: 100%; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border);
            border-radius: var(--radius-md); padding: 12px; color: #e2e8f0;
            font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; min-height: 90px;
            resize: vertical; line-height: 1.5; transition: var(--transition);
        }
        textarea.cyber-input:focus { border-color: var(--primary); background: rgba(0, 0, 0, 0.4); }

        /* Buttons */
        .btn-row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
        .btn {
            height: 44px; padding: 0 20px; border-radius: var(--radius-sm); border: none;
            font-family: 'Inter', sans-serif; font-weight: 600; font-size: 0.85rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: var(--transition); white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-secondary { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid var(--glass-border); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* --- TABLES (PRECISION + MINERA HIGHLIGHT) --- */
        .table-wrapper { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--glass-border); margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        
        th {
            background: rgba(0,0,0,0.3); color: var(--primary); padding: 12px 16px;
            text-align: center; font-family: 'Outfit', sans-serif;
            text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em;
            font-weight: 600; border-bottom: 1px solid var(--glass-border); white-space: nowrap;
        }
        
        td { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #cbd5e1; transition: 0.2s; }
        
        td:first-child, th:first-child { text-align: left; padding-left: 20px; }
        td:not(:first-child), th:not(:first-child) { text-align: right; }
        th:not(:first-child) { text-align: center; }

        tr:hover td { background: rgba(255,255,255,0.03); color: #fff; }

        /* MINERA / COIN HIGHLIGHT STYLES */
        .row-minera {
            background: rgba(139, 92, 246, 0.1) !important; /* Violet tint */
            border-left: 3px solid var(--minera);
        }
        .row-minera td:first-child {
            color: var(--minera) !important;
            font-weight: 700;
            text-shadow: 0 0 10px var(--minera-glow);
        }
        .minera-tag {
            display: inline-block; font-size: 0.65rem; padding: 2px 6px;
            background: var(--minera); color: #fff; border-radius: 4px; margin-left: 6px;
            vertical-align: middle;
        }

        /* Search */
        .table-search {
            width: 200px; padding: 8px 12px; border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border); background: rgba(0,0,0,0.2);
            color: #fff; font-size: 0.85rem; transition: var(--transition);
        }
        .table-search:focus { border-color: var(--primary); outline: none; }

        /* Config Grid */
        .bank-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px; max-height: 180px; overflow-y: auto;
            padding: 12px; background: rgba(0,0,0,0.2);
            border-radius: var(--radius-md); margin-bottom: 16px; border: 1px solid var(--glass-border);
        }
        .bank-opt { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer; user-select: none; padding: 4px; }
        .bank-opt input { accent-color: var(--primary); width: 14px; height: 14px; }

        /* Utilities */
        .hidden { display: none !important; }
        
        /* Toast */
        #toast-container { position: fixed; top: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); color: #fff;
            padding: 16px; border-radius: var(--radius-md);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; gap: 12px;
            transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem; min-width: 300px;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        /* Print Mode */
        @media print {
            body { background: white !important; color: black !important; height: auto; overflow: visible; display: block; }
            #bgCanvas, .sidebar, .btn-row, .file-drop-area, .input-group, .charts-container, .search-container, #opSearch { display: none !important; }
            .main-content { padding: 0 !important; width: 100% !important; margin: 0 !important; }
            .panel { border: 1px solid #ccc !important; box-shadow: none !important; page-break-inside: avoid; margin-bottom: 20px !important; background: white !important; color: black !important; }
            .stat-card { border: 1px solid #ccc !important; color: black !important; background: #fff !important; box-shadow: none; }
            .stat-value, .stat-label { color: black !important; }
            table { border: 1px solid #000 !important; width: 100% !important; color: black !important; }
            th, td { border: 1px solid #000 !important; color: black !important; background: transparent !important; padding: 6px !important; font-size: 9pt !important; text-align: right !important; }
            th:first-child, td:first-child { text-align: left !important; }
            .header-title p { display: none; }
            .table-search { display: none; }
            .row-minera { background: #f0f0f0 !important; }
            .row-minera td:first-child { color: #000 !important; font-weight: bold; }
            .minera-tag { display: none; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--glass-border); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-container { grid-template-columns: 1fr; height: auto; }
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .upload-grid { grid-template-columns: 1fr; }
            .btn-row { flex-direction: column; }
            .btn { width: 100%; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    <div id="toast-container"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-icon"><i class="ph ph-cube-transparent"></i></div>
            <div class="brand-text">
                <h1>TVTOTO</h1>
                <span>Validator Pro</span>
            </div>
        </div>

        <div class="menu-section">
            <div class="menu-title">Main Menu</div>
            <button class="nav-btn active"><i class="ph ph-chart-pie-slice"></i> Dashboard</button>
        </div>

        <div class="menu-section operator-panel">
            <div class="menu-title">Operators</div>
            <input id="opSearch" placeholder="Search operator...">
            <ul id="operatorList" class="operator-list"></ul>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">System</div>
            <button class="nav-btn" onclick="window.print()"><i class="ph ph-printer"></i> Print Report</button>
            <button class="nav-btn" onclick="hapusData()" style="color:var(--danger)"><i class="ph ph-trash"></i> Reset Data</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header>
            <div class="header-title">
                <h2>Financial Dashboard</h2>
                <p>Minera & Transaction Analysis</p>
            </div>
            <div style="text-align:right">
                <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Status</div>
                <div style="color:var(--success); font-weight:600; font-size:0.9rem; margin-top:2px;"><i class="ph ph-check-circle"></i> Active</div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card" style="--primary: var(--success)">
                <div class="stat-label"><i class="ph ph-trend-up"></i> Total Deposit</div>
                <div id="statDeposit" class="stat-value" data-target="0">0</div>
            </div>
            <div class="stat-card" style="--primary: var(--danger)">
                <div class="stat-label"><i class="ph ph-trend-down"></i> Total Withdraw</div>
                <div id="statWithdraw" class="stat-value" data-target="0">0</div>
            </div>
            <div class="stat-card" style="--primary: var(--primary)">
                <div class="stat-label"><i class="ph ph-receipt"></i> Transactions</div>
                <div id="statTrx" class="stat-value" data-target="0">0</div>
            </div>
            <div class="stat-card" style="--primary: var(--minera)">
                <div class="stat-label"><i class="ph ph-currency-btc"></i> Minera / Coin</div>
                <div id="statMinera" class="stat-value" data-target="0">0</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="panel" style="margin:0; padding:16px; display:flex; flex-direction:column;">
                <div class="panel-title" style="font-size:0.9rem; margin-bottom:8px;">Cash Flow Ratio</div>
                <div style="flex:1; position:relative; width:100%;">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>
            <div class="panel" style="margin:0; padding:16px; display:flex; flex-direction:column;">
                <div class="panel-title" style="font-size:0.9rem; margin-bottom:8px;">Bank Performance (Top 5)</div>
                <div style="flex:1; position:relative; width:100%;">
                    <canvas id="bankChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Input Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title"><i class="ph ph-database"></i> Data Processing</div>
            </div>
            
            <div class="upload-grid">
                <div>
                    <label class="input-label">Transaction File</label>
                    <div class="file-drop-area">
                        <i class="ph ph-upload-simple"></i>
                        <span>Upload Excel/CSV</span>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                    </div>
                </div>
                <div>
                    <label class="input-label">Reference File</label>
                    <div class="file-drop-area">
                        <i class="ph ph-users"></i>
                        <span>Upload Ref List</span>
                        <input type="file" id="refFileInput" accept=".xlsx,.xls,.csv" onchange="handleRefFileUpload(event)">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Raw Data Input</label>
                <textarea id="dataInput" class="cyber-input" placeholder="Paste data transaksi di sini..."></textarea>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" onclick="tambahData()"><i class="ph ph-plus-circle"></i> Process Data</button>
                <button class="btn btn-secondary" onclick="hitungJumlahDanTotalTransaksi()"><i class="ph ph-list-dashes"></i> Vertical Recap</button>
                <button class="btn btn-secondary" onclick="generateHorizontalReport()"><i class="ph ph-squares-four"></i> Horizontal Recap</button>
                <button class="btn btn-primary" style="background:var(--success)" onclick="downloadExcel()"><i class="ph ph-microsoft-excel-logo"></i> Export Excel</button>
            </div>
        </div>

        <!-- Configuration Panel -->
        <div id="configPanel" class="panel hidden" style="border: 1px solid var(--primary);">
            <div class="panel-header">
                <div class="panel-title" style="color:var(--primary)"><i class="ph ph-faders"></i> Filter Configuration</div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center;">
                <span style="font-size:0.85rem; color:var(--text-muted)">Select Banks/Coins:</span>
                <div style="display:flex; gap:12px; font-size:0.8rem;">
                    <a href="#" onclick="selectAllBanks(); return false;" style="color:var(--primary);">Select All</a>
                    <a href="#" onclick="deselectAllBanks(); return false;" style="color:var(--danger);">Deselect All</a>
                </div>
            </div>
            <div id="bankConfigList" class="bank-grid"></div>
            <button class="btn btn-primary" onclick="applyConfig()" style="width:100%;">Apply Filter</button>
        </div>

        <!-- Result Area -->
        <div id="hasil"></div>
    </main>

    <script>
        // --- LOGIC SCRIPT ---
        let dataTransaksi = [];
        let dataWithdraw = [];
        let daftarOperator = new Set();
        let operatorReferensi = {};
        let selectedBanks = new Set();
        let allBanks = new Set();
        let charts = {};

        window.addEventListener('DOMContentLoaded', () => {
            initParticles();
            loadFromStorage();
            initCharts();
            updateDashboard();
            updateOperatorList();
        });

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? '<i class="ph ph-check-circle" style="font-size:1.2rem; color:var(--success)"></i>' : '<i class="ph ph-warning-circle" style="font-size:1.2rem; color:var(--danger)"></i>';
            toast.innerHTML = `${icon}<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function initCharts() {
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
            Chart.defaults.font.family = "'Inter', sans-serif";

            const ctx1 = document.getElementById('balanceChart').getContext('2d');
            charts.balance = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: ['Deposit', 'Withdraw'], datasets: [{ data: [0, 0], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0, hoverOffset: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
            });

            const ctx2 = document.getElementById('bankChart').getContext('2d');
            charts.bank = new Chart(ctx2, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Deposit', data: [], backgroundColor: '#10b981', borderRadius: 4 }, { label: 'Withdraw', data: [], backgroundColor: '#ef4444', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function updateCharts() {
            let totalDep = 0, totalWd = 0; const bankPerf = {};
            dataTransaksi.forEach(item => {
                const val = parseInt((item[2]||'0').replace(/[^0-9\-]/g,''),10) || 0; totalDep += val;
                const bank = (item[3]||'Unknown').toString(); bankPerf[bank] = (bankPerf[bank] || {d:0, w:0}); bankPerf[bank].d += val;
            });
            dataWithdraw.forEach(item => {
                const val = parseInt((item[2]||'0').replace(/[^0-9\-]/g,''),10) || 0; totalWd += val;
                const bank = (item[6]||'Unknown').toString(); bankPerf[bank] = (bankPerf[bank] || {d:0, w:0}); bankPerf[bank].w += val;
            });
            charts.balance.data.datasets[0].data = [totalDep, totalWd]; charts.balance.update();
            const sortedBanks = Object.entries(bankPerf).sort((a,b) => (b[1].d + b[1].w) - (a[1].d + a[1].w)).slice(0, 5);
            charts.bank.data.labels = sortedBanks.map(x => x[0]);
            charts.bank.data.datasets[0].data = sortedBanks.map(x => x[1].d);
            charts.bank.data.datasets[1].data = sortedBanks.map(x => x[1].w); charts.bank.update();
        }

        function tokenizeLine(line){
            line = line.replace(/\u00A0/g,' ').trim(); if(!line) return [];
            let tokens = line.split('\t'); if(tokens.length === 1) tokens = line.split(',');
            if(tokens.length === 1) tokens = line.split(/\s{2,}/); if(tokens.length === 1) tokens = line.split(/\s+/);
            return tokens.map(t => t.replace(/^"|"$/g,'').trim());
        }

        function handleFileUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
                    let textData = ''; workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        textData += jsonData.map(row => row.join('\t')).join('\n');
                    });
                    document.getElementById('dataInput').value = textData; showToast(`File loaded: ${file.name}`);
                } catch (error) { showToast('Failed to read file', 'error'); console.error(error); }
            }; reader.readAsArrayBuffer(file);
        }

        function handleRefFileUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
                    let textData = ''; workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        textData += jsonData.map(row => row.join('\t')).join('\n');
                    });
                    document.getElementById('refInput').value = textData; setReferensi();
                } catch (error) { showToast('Failed to read reference', 'error'); }
            }; reader.readAsArrayBuffer(file);
        }

        function tambahData(){
            const dataInput = document.getElementById('dataInput').value; if(!dataInput.trim()){ showToast('Data is empty', 'error'); return; }
            const dataLines = dataInput.trim().split('\n'); let addedCount = 0;
            dataLines.forEach(line=>{
                const tokens = tokenizeLine(line); if(!tokens.length) return;
                const statusToken = (tokens[10] || tokens[0] || "").toString().toLowerCase();
                const isWithdraw = (statusToken === 'withdraw' || statusToken === 'wd' || statusToken.includes('withdraw'));
                if(isWithdraw){
                    const row = new Array(12).fill(''); for(let i=0;i<Math.min(tokens.length,12);i++) row[i] = tokens[i];
                    if(!row[10] || !/withdraw/i.test(row[10])) row[10] = 'Withdraw'; dataWithdraw.push(row);
                    const operatorName = (row[9]||row[0]||'').toString().trim(); if(operatorName){ daftarOperator.add(operatorName); if(operatorReferensi[operatorName]) { operatorReferensi[operatorName].hasWithdraw = true; operatorReferensi[operatorName].withdrawStatus = true; } }
                } else {
                    const row = new Array(12).fill(''); for(let i=0;i<Math.min(tokens.length,12);i++) row[i] = tokens[i];
                    if(!/[\d]/.test((row[2]||'')) ){ const found = tokens.find(t => /[0-9]/.test(t)); if(found) row[2] = found; }
                    if(!row[10]) row[10] = 'Deposit'; dataTransaksi.push(row);
                    const operatorName = (row[9]||row[1]||row[0]||'').toString().trim(); if(operatorName){ daftarOperator.add(operatorName); if(operatorReferensi[operatorName]) operatorReferensi[operatorName].status = true; }
                } addedCount++;
            });
            document.getElementById('dataInput').value=''; updateOperatorList(); updateDashboard(); saveToStorage(); showToast(`${addedCount} Transactions Processed`);
        }

        function hapusData(){
            dataTransaksi = []; dataWithdraw = []; daftarOperator.clear(); document.getElementById('hasil').innerHTML = '';
            document.getElementById('fileInput').value = ''; document.getElementById('configPanel').classList.add('hidden');
            localStorage.removeItem('tvtoto_data'); updateDashboard(); updateOperatorList(); showToast('All data has been reset', 'error');
        }

        function animateValue(obj, start, end, duration, isCurrency = false) {
            let startTimestamp = null; const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                let val = Math.floor(progress * (end - start) + start);
                if(isCurrency) { obj.innerHTML = formatRupiah(val); } else { obj.innerHTML = val.toLocaleString(); }
                if (progress < 1) { window.requestAnimationFrame(step); }
            }; window.requestAnimationFrame(step);
        }

        function updateDashboard() {
            let totalDep = 0, totalWd = 0, totalMinera = 0; 
            dataTransaksi.forEach(item => {
                const val = parseInt((item[2]||'0').replace(/[^0-9\-]/g,''),10)||0; totalDep += val;
                const bank = (item[3]||'').toString(); if(bank.toLowerCase().includes('minera')) totalMinera += val;
            });
            dataWithdraw.forEach(item => {
                const val = parseInt((item[2]||'0').replace(/[^0-9\-]/g,''),10)||0; totalWd += val;
                // Check if Withdraw is Minera too
                const bank = (item[6]||'').toString(); if(bank.toLowerCase().includes('minera')) totalMinera -= val;
            });
            const net = totalDep - totalWd;

            animateValue(document.getElementById('statDeposit'), 0, totalDep, 1500);
            animateValue(document.getElementById('statWithdraw'), 0, totalWd, 1500);
            animateValue(document.getElementById('statTrx'), 0, (dataTransaksi.length + dataWithdraw.length), 1500);
            animateValue(document.getElementById('statMinera'), 0, totalMinera, 1500, true); // New Minera Stat

            const netEl = document.getElementById('totalIncomeDisplay'); netEl.innerText = formatRupiah(net); netEl.style.color = net >= 0 ? 'var(--success)' : 'var(--danger)'; updateCharts();
        }

        // Helper to check Minera
        function isMineraMethod(name) {
            return name.toLowerCase().includes('minera');
        }

        function hitungJumlahDanTotalTransaksi(){
            const hasilDeposit = processAggregate(dataTransaksi, 3); const hasilWithdraw = processAggregate(dataWithdraw, 6);
            let html = `<div class="panel"><div class="panel-header"><div class="panel-title"><i class="ph ph-list-dashes"></i> Vertical Recap</div><input type="text" class="table-search" placeholder="Search bank/coin..." onkeyup="filterTable('vertTable', this.value)"></div><div class="table-wrapper"><table id="vertTable"><thead><tr><th colspan="3" style="color:var(--success)">Deposit</th></tr><tr><th>Bank / Koin</th><th>Count</th><th>Total</th></tr></thead><tbody>`;
            for(const bank in hasilDeposit){
                const isMinera = isMineraMethod(bank);
                const rowClass = isMinera ? 'class="row-minera"' : '';
                const mineraTag = isMinera ? '<span class="minera-tag">MINERA</span>' : '';
                html += `<tr ${rowClass}><td>${bank} ${mineraTag}</td><td>${hasilDeposit[bank].count}</td><td>${hasilDeposit[bank].total.toLocaleString()}</td></tr>`;
            }
            html += `</tbody></table></div><div class="table-wrapper"><table id="vertTableWd"><thead><tr><th colspan="3" style="color:var(--danger)">Withdraw</th></tr><tr><th>Bank / Koin</th><th>Count</th><th>Total</th></tr></thead><tbody>`;
            for(const bank in hasilWithdraw){
                const isMinera = isMineraMethod(bank);
                const rowClass = isMinera ? 'class="row-minera"' : '';
                const mineraTag = isMinera ? '<span class="minera-tag">MINERA</span>' : '';
                html += `<tr ${rowClass}><td>${bank} ${mineraTag}</td><td>${hasilWithdraw[bank].count}</td><td>${hasilWithdraw[bank].total.toLocaleString()}</td></tr>`;
            }
            html += `</tbody></table></div></div>`; document.getElementById('hasil').innerHTML = html;
        }

        function filterTable(tableId, query) {
            const filter = query.toLowerCase(); const table = document.getElementById(tableId); const tr = table.getElementsByTagName("tr");
            for (let i = 2; i < tr.length; i++) { let td = tr[i].getElementsByTagName("td")[0]; if (td) { let txtValue = td.textContent || td.innerText; tr[i].style.display = (txtValue.toLowerCase().indexOf(filter) > -1) ? "" : "none"; } }
        }

        function processAggregate(dataArray, bankIndex) {
            const result = {}; dataArray.forEach(item=>{ const bank = (item[bankIndex]||'Unknown').toString(); const jumlah = parseInt((item[2]||'0').toString().replace(/[^0-9\-]/g,''),10) || 0; if(!result[bank]) result[bank] = { total:0, count:0 }; result[bank].total += jumlah; result[bank].count++; }); return result;
        }

        function generateHorizontalReport() {
            if(!dataTransaksi.length && !dataWithdraw.length){ showToast('No data available', 'error'); return; } allBanks.clear();
            dataTransaksi.forEach(item => allBanks.add((item[3]||'Unknown').toString())); dataWithdraw.forEach(item => allBanks.add((item[6]||'Unknown').toString())); showBankConfig();
        }

        function showBankConfig() {
            const configPanel = document.getElementById('configPanel'); const bankConfigList = document.getElementById('bankConfigList');
            configPanel.classList.remove('hidden'); bankConfigList.innerHTML = ''; if(selectedBanks.size === 0) selectedBanks = new Set(allBanks);
            allBanks.forEach(bank => {
                const div = document.createElement('div'); div.className = 'bank-opt'; const isChecked = selectedBanks.has(bank) ? 'checked' : '';
                div.innerHTML = `<input type="checkbox" id="b_${bank}" ${isChecked}> <label for="b_${bank}">${bank}</label>`;
                div.querySelector('input').onchange = (e) => { if(e.target.checked) selectedBanks.add(bank); else selectedBanks.delete(bank); }; bankConfigList.appendChild(div);
            });
        }

        function selectAllBanks() { selectedBanks = new Set(allBanks); document.querySelectorAll('#bankConfigList input').forEach(cb => cb.checked = true); }
        function deselectAllBanks() { selectedBanks.clear(); document.querySelectorAll('#bankConfigList input').forEach(cb => cb.checked = false); }
        function applyConfig() { if(selectedBanks.size === 0) { showToast('Select at least 1 bank', 'error'); return; } createHorizontalTable(); }

        function createHorizontalTable() {
            const hasilDeposit = processAggregate(dataTransaksi, 3); const hasilWithdraw = processAggregate(dataWithdraw, 6);
            let html = `<div class="panel"><div class="panel-header"><div class="panel-title"><i class="ph ph-squares-four"></i> Horizontal Recap</div><input type="text" class="table-search" placeholder="Search bank/coin..." onkeyup="filterTable('horizTable', this.value)"></div><div class="table-wrapper"><table id="horizTable"><thead><tr><th rowspan="2">Bank / Koin</th><th colspan="2" style="color:var(--success)">Deposit</th><th colspan="2" style="color:var(--danger)">Withdraw</th><th colspan="2" style="color:var(--warning)">Net</th></tr><tr><th>Count</th><th>Total</th><th>Count</th><th>Total</th><th>Count</th><th>Total</th></tr></thead><tbody>`;
            let grandD=0, grandW=0, grandDC=0, grandWC=0; selectedBanks.forEach(bank => {
                const d = hasilDeposit[bank] || {total:0, count:0}; const w = hasilWithdraw[bank] || {total:0, count:0}; const net = d.total - w.total; const netC = d.count - w.count; const netColor = net >= 0 ? 'var(--success)' : 'var(--danger)'; grandD += d.total; grandW += w.total; grandDC += d.count; grandWC += w.count;
                
                const isMinera = isMineraMethod(bank);
                const rowClass = isMinera ? 'class="row-minera"' : '';
                const mineraTag = isMinera ? '<span class="minera-tag">MINERA</span>' : '';
                
                html += `<tr ${rowClass}><td>${bank} ${mineraTag}</td><td>${d.count}</td><td>${d.total.toLocaleString()}</td><td>${w.count}</td><td>${w.total.toLocaleString()}</td><td>${netC}</td><td style="color:${netColor}; font-weight:600;">${net.toLocaleString()}</td></tr>`;
            });
            const grandNet = grandD - grandW; const grandNetColor = grandNet >= 0 ? 'var(--success)' : 'var(--danger)';
            html += `<tr style="background:rgba(255,255,255,0.05); font-weight:700;"><td>GRAND TOTAL</td><td>${grandDC}</td><td>${grandD.toLocaleString()}</td><td>${grandWC}</td><td>${grandW.toLocaleString()}</td><td>${grandDC-grandWC}</td><td style="color:${grandNetColor}; font-size:1.1em;">${grandNet.toLocaleString()}</td></tr></tbody></table></div></div>`;
            document.getElementById('hasil').innerHTML = html; document.getElementById('configPanel').classList.add('hidden');
        }

        function downloadExcel() {
            if(!dataTransaksi.length && !dataWithdraw.length){ showToast('No data to export', 'error'); return; } const wb = XLSX.utils.book_new();
            const combinedData = [["Akun", "Tgl", "Jumlah", "Bank Byr", "Rek Byr", "Nm Byr", "Bank Terima", "Rek Terima", "Nm Terima", "Operator", "Jenis", "Status"], ...dataTransaksi, ...dataWithdraw];
            const wsRaw = XLSX.utils.aoa_to_sheet(combinedData); XLSX.utils.book_append_sheet(wb, wsRaw, "Raw Data");
            const dData = processAggregate(dataTransaksi, 3); const wData = processAggregate(dataWithdraw, 6); const summaryRows = [["Bank/Coin", "Dep Count", "Dep Total", "Wd Count", "Wd Total", "Net"]];
            const activeBanks = selectedBanks.size > 0 ? selectedBanks : new Set([...Object.keys(dData), ...Object.keys(wData)]);
            activeBanks.forEach(b => { const d = dData[b] || {c:0,t:0}; const w = wData[b] || {c:0,t:0}; summaryRows.push([b, d.c, d.t, w.c, w.t, d.t - w.t]); });
            const wsSum = XLSX.utils.aoa_to_sheet(summaryRows); XLSX.utils.book_append_sheet(wb, wsSum, "Summary"); XLSX.writeFile(wb, `Laporan_TVTOTO_${new Date().getTime()}.xlsx`); showToast('Excel Exported Successfully');
        }

        function saveToStorage() { localStorage.setItem('tvtoto_data', JSON.stringify({ transaksi: dataTransaksi, withdraw: dataWithdraw, ref: operatorReferensi })); }
        function loadFromStorage() {
            const saved = localStorage.getItem('tvtoto_data'); if(saved) {
                try { const parsed = JSON.parse(saved); dataTransaksi = parsed.transaksi || []; dataWithdraw = parsed.withdraw || []; operatorReferensi = parsed.ref || {}; if(dataTransaksi.length || dataWithdraw.length) showToast('Previous session restored'); } catch(e) { console.error("Load error", e); }
            }
        }

        function setReferensi() {
             const text = document.getElementById('refInput') ? document.getElementById('refInput').value : ''; if(!text) { showToast('Please upload/paste reference data', 'error'); return; }
             const lines = text.split('\n'); operatorReferensi = {}; let count = 0;
             lines.forEach((rawLine, idx)=>{
                 let line = rawLine.replace(/\u00A0/g,' ').trim(); if(!line) return; if(idx === 0 && /operator|deposit|withdraw|no/i.test(line)) return;
                 const tokens = line.split(/\s+/); let opIdx = tokens.findIndex(t => /[A-Za-z]/.test(t)); if(opIdx === -1) opIdx = 0; let nameParts = [];
                 for(let j=opIdx;j<tokens.length;j++){ if(/^[0-9\-,.]+$/.test(tokens[j])) break; nameParts.push(tokens[j]); }
                 const nama = nameParts.join(' ').replace(/[^A-Za-z0-9_\- ]/g,'').trim(); if(!nama) return;
                 operatorReferensi[nama] = { status:false, hasWithdraw: false, withdrawStatus: false }; count++;
             }); updateOperatorList(); saveToStorage(); showToast(`${count} Reference Operators Saved`);
        }
        
        const refInputHidden = document.createElement('textarea'); refInputHidden.id = 'refInput'; refInputHidden.style.display = 'none'; document.body.appendChild(refInputHidden);

        function updateOperatorList(){
            const list = document.getElementById('operatorList'); list.innerHTML = ''; const keys = Object.keys(operatorReferensi).sort((a,b)=>a.localeCompare(b));
            if(!keys.length){ list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.8rem">No data</div>'; return; }
            keys.forEach(op => {
                const li = document.createElement('li'); li.className = 'operator-item'; let badgeColor = 'var(--text-muted)'; let badgeBg = 'rgba(255,255,255,0.1)'; let badgeText = 'Wait';
                if(operatorReferensi[op].status) { badgeColor = '#fff'; badgeBg = 'var(--success)'; badgeText = 'DEPO'; } else if(operatorReferensi[op].withdrawStatus) { badgeColor = '#fff'; badgeBg = 'var(--danger)'; badgeText = 'WD'; } else if(operatorReferensi[op].hasWithdraw) { badgeColor = '#fff'; badgeBg = 'var(--primary)'; badgeText = 'Mix'; }
                li.innerHTML = `<span>${op}</span><span class="op-badge" style="color:${badgeColor}; background:${badgeBg}">${badgeText}</span>`; li.dataset.name = op.toLowerCase(); list.appendChild(li);
            });
        }

        function formatRupiah(angka) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(angka); }

        function initParticles() {
            const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d'); let particles = [];
            function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; } window.addEventListener('resize', resize); resize();
            class Particle { constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.vx = (Math.random() - 0.5) * 0.2; this.vy = (Math.random() - 0.5) * 0.2; this.size = Math.random() * 1.5; } update() { this.x += this.vx; this.y += this.vy; if(this.x < 0 || this.x > canvas.width) this.vx *= -1; if(this.y < 0 || this.y > canvas.height) this.vy *= -1; } draw() { ctx.fillStyle = 'rgba(59, 130, 246, 0.3)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
            for(let i=0; i<50; i++) particles.push(new Particle());
            function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach((p, index) => { p.update(); p.draw(); for(let j=index; j<particles.length; j++) { const dx = particles[j].x - p.x; const dy = particles[j].y - p.y; const dist = Math.sqrt(dx*dx + dy*dy); if(dist < 100) { ctx.strokeStyle = `rgba(59, 130, 246, ${0.05 - dist/2000})`; ctx.lineWidth = 0.5; ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke(); } } }); requestAnimationFrame(animate); } animate();
        }
    </script>
</body>
</html>
